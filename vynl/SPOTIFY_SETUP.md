# Spotify Export Setup Guide

This guide will help you set up Spotify playlist export functionality in Vynl.

## Prerequisites

1. A Spotify account
2. Access to the Spotify Developer Dashboard
3. Environment variables configured in your project

## Step 1: Create a Spotify App

1. Go to [Spotify Developer Dashboard](https://developer.spotify.com/dashboard)
2. Log in with your Spotify account
3. Click "Create App"
4. Fill in the app details:
   - App name: `Vynl` (or your preferred name)
   - App description: `Music playlist builder and exporter`
   - Redirect URI: See Step 2 below
   - Category: `Other`
5. Accept the terms and create the app

## Step 2: Configure Redirect URIs

You need to add redirect URIs for both development and production:

### For Development (Mobile):
- `exp://localhost:8081` (Expo development)
- Or use Expo's auth proxy: `https://auth.expo.io/@your-username/vynl`

### For Development (Web):
- `http://localhost:8081/api/spotify/callback`
- `http://localhost:19006/api/spotify/callback` (Expo web)

### For Production:
- Add your production domain: `https://yourdomain.com/api/spotify/callback`
- For mobile production, use your app's custom URL scheme

### How to find your redirect URI:

For mobile development, the redirect URI is automatically generated by Expo. You can check it by:
1. Running your app in development
2. The redirect URI will be shown in the console when you initiate auth
3. Copy that URI and add it to your Spotify app settings

## Step 3: Get Your Client ID and Client Secret

1. In your Spotify app dashboard, you'll see:
   - **Client ID**: Copy this (you'll need it for `EXPO_PUBLIC_SPOTIFY_CLIENT_ID`)
   - **Client Secret**: Click "Show Client Secret" and copy it (you'll need it for `SPOTIFY_CLIENT_SECRET`)

## Step 4: Configure Environment Variables

### For Development (`.env.local` or `.env`):

Create a `.env` file in the `vynl/` directory:

```env
EXPO_PUBLIC_SPOTIFY_CLIENT_ID=your_client_id_here
SPOTIFY_CLIENT_SECRET=your_client_secret_here
EXPO_PUBLIC_API_URL=http://localhost:8081
```

### For Production:

Set these as environment variables in your deployment platform:
- `EXPO_PUBLIC_SPOTIFY_CLIENT_ID`: Your Spotify Client ID (public, safe to expose)
- `SPOTIFY_CLIENT_SECRET`: Your Spotify Client Secret (keep this secret, server-side only)
- `EXPO_PUBLIC_API_URL`: Your production API URL

**Important Security Note**: 
- `EXPO_PUBLIC_SPOTIFY_CLIENT_ID` is safe to expose in client-side code
- `SPOTIFY_CLIENT_SECRET` must NEVER be exposed in client-side code. It should only be used in server-side API routes (`/api/spotify/token` and `/api/spotify/refresh`)

## Step 5: Update Your Spotify App Settings

1. Go back to your Spotify app in the dashboard
2. Click "Edit Settings"
3. Add all your redirect URIs (from Step 2)
4. Save changes

## Step 6: Test the Integration

1. Start your development server: `npm start`
2. Navigate to a playlist in your app
3. Click "Export to Spotify"
4. You should be redirected to Spotify to authorize
5. After authorization, you'll be redirected back to the app
6. The playlist should be exported to Spotify

## Troubleshooting

### "Invalid redirect URI" error
- Make sure the redirect URI in your Spotify app settings matches exactly what's being used
- For mobile, check the console for the actual redirect URI being used
- Update your Spotify app settings with the correct URI

### "Failed to exchange code for token" error
- Make sure `SPOTIFY_CLIENT_SECRET` is set in your environment variables
- Check that your backend API route (`/api/spotify/token`) is working
- Verify that the client secret in your environment matches the one in Spotify dashboard

### "Not authenticated with Spotify" error
- Try disconnecting and reconnecting your Spotify account
- Check that tokens are being stored correctly in AsyncStorage
- Verify that the OAuth flow completed successfully

### Token refresh issues
- Tokens expire after 1 hour. The app should automatically refresh them
- If refresh fails, the user will need to reconnect their Spotify account
- Make sure the refresh token API route is configured correctly

## API Routes

The following API routes are used for Spotify integration:

- `/api/spotify/token` - Exchanges authorization code for access token (POST)
- `/api/spotify/refresh` - Refreshes access token using refresh token (POST)
- `/api/spotify/callback` - Handles OAuth callback (GET, web only)

These routes should be configured to use the `SPOTIFY_CLIENT_SECRET` environment variable securely on the server side.

## Security Best Practices

1. **Never expose client secret**: The `SPOTIFY_CLIENT_SECRET` should only be used in server-side API routes
2. **Use HTTPS in production**: Always use HTTPS for OAuth callbacks in production
3. **Validate redirect URIs**: Only allow redirect URIs that you control
4. **Token storage**: Tokens are stored securely in AsyncStorage (mobile) or localStorage (web)
5. **Token refresh**: Implement automatic token refresh to avoid requiring users to re-authenticate

## Additional Resources

- [Spotify Web API Documentation](https://developer.spotify.com/documentation/web-api)
- [Spotify Authorization Guide](https://developer.spotify.com/documentation/web-api/concepts/authorization)
- [Expo AuthSession Documentation](https://docs.expo.dev/guides/authentication/#spotify)

